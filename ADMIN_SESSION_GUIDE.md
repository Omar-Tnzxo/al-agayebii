# دليل الاستخدام السريع - نظام جلسات الأدمن

## 🚀 البدء السريع

### 1. تسجيل الدخول
انتقل إلى `/admin` وأدخل بيانات المدير:
```
البريد الإلكتروني: admin@example.com
كلمة المرور: ********
```

**ما يحدث:**
1. يتم التحقق من البيانات عبر `/api/admin/login`
2. يتم إنشاء جلسة آمنة مع كوكي httpOnly
3. يتم حفظ البيانات في localStorage أو sessionStorage (حسب "تذكرني")
4. يتم التوجيه تلقائياً إلى `/dashboard`

---

### 2. أثناء الاستخدام

**التحديث التلقائي:**
- عند كل زيارة لصفحة جديدة في لوحة التحكم
- يتم استدعاء `/api/admin/check-session` تلقائياً
- يتم تحديث وقت انتهاء الجلسة بشكل تلقائي
- النتيجة: الجلسة تبقى نشطة طالما تستخدم النظام

**الفحص الدوري:**
- كل 60 ثانية، يتم فحص حالة الحساب
- يتم استدعاء `/api/admin/check-active`
- إذا تم تعطيل الحساب، يتم الخروج تلقائياً

---

### 3. تسجيل الخروج

**طريقتان:**

#### أ. الخروج اليدوي:
- انقر على أيقونة تسجيل الخروج في الهيدر أو الشريط الجانبي
- يتم عرض رسالة "جاري تسجيل الخروج..."
- يتم حذف الجلسة والبيانات المحلية
- يتم التوجيه إلى `/admin` مع رسالة نجاح

#### ب. الخروج التلقائي:
يحدث في الحالات التالية:
- انتهاء صلاحية الجلسة (بعد 7 أيام)
- تعطيل الحساب من قبل مدير آخر
- تغيير الدور (role) من قبل مدير آخر
- حذف الحساب

---

## 🔒 السيناريوهات الأمنية

### السيناريو 1: محاولة الوصول بدون تسجيل دخول
```
1. زيارة /dashboard
2. Middleware يفحص الكوكي
3. لا توجد جلسة
4. التوجيه إلى /admin?message=يرجى تسجيل الدخول أولاً
```

### السيناريو 2: جلسة منتهية الصلاحية
```
1. زيارة /dashboard (بعد 7 أيام)
2. Middleware يفحص عمر الجلسة
3. الجلسة منتهية
4. حذف الكوكي
5. التوجيه إلى /admin?message=انتهت صلاحية الجلسة
```

### السيناريو 3: تعطيل الحساب أثناء الاستخدام
```
1. المدير يستخدم لوحة التحكم
2. مدير آخر يعطّل الحساب
3. بعد 60 ثانية (أو عند الانتقال لصفحة جديدة)
4. الفحص الدوري يكتشف التعطيل
5. حذف الجلسة والبيانات المحلية
6. التوجيه إلى /admin?message=تم تعطيل حسابك
```

### السيناريو 4: جلسة غير صالحة
```
1. زيارة /dashboard
2. check-session يتحقق من قاعدة البيانات
3. الحساب غير موجود أو معطّل
4. حذف الكوكي تلقائياً
5. إرجاع authenticated: false
6. Dashboard layout يوجه إلى /admin
```

---

## 🛠️ للمطورين: استخدام النظام في API Routes جديدة

### مثال: حماية API route

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { requireAdminAuth } from '@/lib/auth-utils';

export async function GET(request: NextRequest) {
  // التحقق من المصادقة
  const authResult = await requireAdminAuth(request);
  
  if (!authResult.authorized) {
    return NextResponse.json(
      { error: authResult.error || 'غير مصرح' },
      { status: 401 }
    );
  }
  
  // المدير مصرح له
  const adminId = authResult.admin!.id;
  const adminEmail = authResult.admin!.email;
  const adminRole = authResult.admin!.role;
  
  // ... باقي المنطق
  
  return NextResponse.json({
    success: true,
    data: { /* بيانات */ }
  });
}
```

### مثال: التحقق من دور معين

```typescript
export async function DELETE(request: NextRequest) {
  const authResult = await requireAdminAuth(request);
  
  if (!authResult.authorized) {
    return NextResponse.json(
      { error: authResult.error },
      { status: 401 }
    );
  }
  
  // التحقق من الدور
  if (authResult.admin!.role !== 'super_admin') {
    return NextResponse.json(
      { error: 'يجب أن تكون مدير أعلى لحذف العناصر' },
      { status: 403 }
    );
  }
  
  // ... منطق الحذف
}
```

---

## 📊 مراقبة النظام

### ما يتم تسجيله (Logs):

#### في تسجيل الدخول:
```
✅ تم تسجيل الدخول بنجاح: admin@example.com
```

#### في تسجيل الخروج:
```
✅ تم تسجيل خروج المدير: admin@example.com
```

#### في التحقق من الجلسة:
```
❌ خطأ في التحقق من الجلسة: [تفاصيل الخطأ]
```

#### في فحص حالة الحساب:
```
❌ خطأ في فحص حالة المدير: [تفاصيل الخطأ]
```

---

## 🐛 معالجة المشاكل الشائعة

### المشكلة 1: "يرجى تسجيل الدخول أولاً"
**السبب:** لا توجد جلسة نشطة
**الحل:** سجّل الدخول من `/admin`

### المشكلة 2: "انتهت صلاحية الجلسة"
**السبب:** مرت أكثر من 7 أيام منذ آخر تسجيل دخول
**الحل:** سجّل الدخول مرة أخرى

### المشكلة 3: "تم تعطيل حسابك"
**السبب:** تم تعطيل الحساب من قبل مدير آخر
**الحل:** اتصل بالمدير الأعلى لإعادة تفعيل الحساب

### المشكلة 4: "جلسة غير صالحة"
**السبب:** تلف في بيانات الكوكي أو تغيير يدوي
**الحل:** سجّل الدخول مرة أخرى

### المشكلة 5: الخروج التلقائي المتكرر
**الأسباب المحتملة:**
1. مشكلة في الاتصال بقاعدة البيانات
2. الحساب تم تعطيله فعلاً
3. تغيير في بيانات الحساب

**الحل:**
1. تحقق من logs الخادم
2. تحقق من حالة الحساب في قاعدة البيانات
3. تحقق من اتصال قاعدة البيانات

---

## 🔧 الإعدادات المتقدمة

### تغيير عمر الجلسة:

في `lib/auth-utils.ts`:
```typescript
const SESSION_DURATION = 60 * 60 * 24 * 7; // 7 أيام
// غيّر إلى:
const SESSION_DURATION = 60 * 60 * 24 * 30; // 30 يوم
```

### تغيير تردد الفحص الدوري:

في `app/dashboard/layout.tsx`:
```typescript
const interval = setInterval(checkAccountStatus, 60000); // 60 ثانية
// غيّر إلى:
const interval = setInterval(checkAccountStatus, 30000); // 30 ثانية
```

### تعطيل التحديث التلقائي للجلسة:

في `app/api/admin/check-session/route.ts`:
```typescript
// احذف أو علّق هذا السطر:
refreshAdminSession(response, sessionData);
```

⚠️ **تحذير:** تعطيل التحديث التلقائي سيؤدي إلى خروج المستخدمين بعد 7 أيام بالضبط من تسجيل الدخول، حتى لو كانوا يستخدمون النظام.

---

## ✅ قائمة التحقق للاختبار

- [ ] تسجيل دخول بحساب صحيح
- [ ] تسجيل دخول بحساب خاطئ
- [ ] تسجيل دخول بحساب معطّل
- [ ] تفعيل "تذكرني" والتحقق من localStorage
- [ ] عدم تفعيل "تذكرني" والتحقق من sessionStorage
- [ ] الانتقال بين صفحات لوحة التحكم
- [ ] إعادة تحميل الصفحة أثناء استخدام لوحة التحكم
- [ ] تسجيل الخروج اليدوي
- [ ] تعطيل الحساب أثناء الاستخدام والتحقق من الخروج التلقائي
- [ ] انتظار 60 ثانية والتحقق من الفحص الدوري
- [ ] محاولة الوصول إلى /dashboard بدون تسجيل دخول
- [ ] التحقق من رسائل الخطأ الواضحة

---

## 📚 مراجع إضافية

- `ADMIN_SESSION_IMPROVEMENTS.md` - تفاصيل التحسينات الكاملة
- `ADMIN_SESSION_COMPARISON.md` - مقارنة بين النظام القديم والجديد
- `ADMIN_SESSION_SUMMARY.md` - ملخص سريع للتحسينات

---

تم الإنشاء: أكتوبر 2025 📝
